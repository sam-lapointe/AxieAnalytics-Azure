trigger: none

pool:
  name: OnPrem

variables:
- group: SonarQube
- group: Python

jobs:
  - job: Tests
        
    steps:
    - script: |
        if ! python$(PYTHON_VERSION) > /dev/null 2>&1; then
          echo "‚ùå python$(PYTHON_VERSION) must be installed on the Self-Hosted Agent.
          exit 1
        else
          python$(PYTHON_VERSION) --version
        fi
      displayName: Check Python Version

    - script: |
        python$(PYTHON_VERSION) -m venv venv
        source venv/bin/activate
        pip install -r requirements.txt
        pip install -r requirement-dev.txt
      displayName: Install Dependencies
      workingDirectory: $(System.DefaultWorkingDirectory)/webhook_listener
    
    - script: |
        pytest test_function_app.py
      displayName: Unit Tests
      workingDirectory: $(System.DefaultWorkingDirectory)/webhook_listener

    - script: |
        ruff format --check --diff *.py
      displayName: Check formatting
      workingDirectory: $(System.DefaultWorkingDirectory)/webhook_listener

    - script: |
        ruff check *.py
      displayName: Check lint
      workingDirectory: $(System.DefaultWorkingDirectory)/webhook_listener

    - task: SonarQubePrepare@7
      inputs:
        SonarQube: $(SONARQUBE_SERVICE_CONNECTION_NAME)
        scannerMode: 'cli'
        configMode: 'manual'
        cliProjectKey: $(SONARQUBE_PROJECT_KEY)
        cliProjectName: $(SONARQUBE_PROJECT_NAME)
        cliSources: $(System.DefaultWorkingDirectory)/webhook_listener

    - task: SonarQubeAnalyze@7
      inputs:
        jdkversion: 'JAVA_HOME_17_X64'

    - task: SonarQubePublish@7
      inputs:
        pollingTimeoutSec: '300'